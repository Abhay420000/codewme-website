{% extends 'base.html' %}

{% block title %}Online Compiler - CodeWme{% endblock %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/online_compiler.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.min.js"></script>
{% endblock %}

{% block content %}
<div class="compiler-wrapper">
    
    <div class="compiler-header">
        <div class="header-left">
            <div class="compiler-icon">ðŸ’»</div>
            <div>
                <h1 class="compiler-title">Code Playground</h1>
                <p class="compiler-sub">Run code instantly. 30+ Languages Supported.</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="lang-selector-container">
                <input type="text" id="langSearch" class="lang-search-input" placeholder="Search Language..." onkeyup="filterLanguages()" onclick="toggleLangList()">
                <div id="langList" class="lang-list">
                    </div>
            </div>

            <button id="runBtn" class="btn-run" onclick="runCode()">
                â–¶ Run Code
            </button>
        </div>
    </div>

    <div class="compiler-grid">
        
        <div class="editor-container">
            <div class="panel-label">Source Code</div>
            <div id="editor"></div>
        </div>

        <div class="io-container">
            
            <div class="io-box" id="io-input-box" style="flex: 0 0 30%;">
                <div class="panel-label">Input (stdin)</div>
                <textarea id="stdin" class="io-textarea" placeholder="Enter input here BEFORE running your code...&#10;Example:&#10;John&#10;25"></textarea>
            </div>

            <div class="io-box" id="io-output-box" style="flex: 1;">
                <div class="panel-label">Output (stdout)</div>
                <div id="output" class="io-output"></div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. EXTENSIVE LANGUAGE CONFIGURATION ---
    const languages = [
        { name: "Python", id: "python", version: "3.10.0", mode: "python", snippet: 'print("Hello from Python!")\nname = input("Enter name: ")\nprint(f"Nice to meet you, {name}")' },
        { name: "JavaScript", id: "javascript", version: "18.15.0", mode: "javascript", snippet: 'console.log("Hello from NodeJS!");' },
        { name: "Java", id: "java", version: "15.0.2", mode: "java", snippet: 'import java.util.Scanner;\npublic class Main {\n    public static void main(String[] args) {\n        Scanner scanner = new Scanner(System.in);\n        if(scanner.hasNext()) {\n            String name = scanner.nextLine();\n            System.out.println("Hello " + name);\n        } else {\n            System.out.println("Hello Java! (No Input Provided)");\n        }\n    }\n}' },
        { name: "C++ (GCC)", id: "c++", version: "10.2.0", mode: "c_cpp", snippet: '#include <iostream>\nusing namespace std;\nint main() {\n    string name;\n    if (cin >> name) {\n        cout << "Hello " << name;\n    } else {\n        cout << "Hello C++";\n    }\n    return 0;\n}' },
        { name: "C (GCC)", id: "c", version: "10.2.0", mode: "c_cpp", snippet: '#include <stdio.h>\nint main() {\n    printf("Hello C World");\n    return 0;\n}' },
        { name: "C#", id: "csharp", version: "6.12.0", mode: "csharp", snippet: 'using System;\nclass Program {\n    static void Main() {\n        Console.WriteLine("Hello C#");\n    }\n}' },
        { name: "Go", id: "go", version: "1.16.2", mode: "golang", snippet: 'package main\nimport "fmt"\nfunc main() {\n    fmt.Println("Hello Go")\n}' },
        { name: "Rust", id: "rust", version: "1.68.2", mode: "rust", snippet: 'fn main() {\n    println!("Hello Rust");\n}' },
        { name: "PHP", id: "php", version: "8.2.3", mode: "php", snippet: '<?php echo "Hello PHP"; ?>' },
        { name: "Swift", id: "swift", version: "5.3.3", mode: "swift", snippet: 'print("Hello Swift")' },
        { name: "TypeScript", id: "typescript", version: "5.0.3", mode: "typescript", snippet: 'const msg: string = "Hello TS";\nconsole.log(msg);' },
        { name: "Ruby", id: "ruby", version: "3.0.1", mode: "ruby", snippet: 'puts "Hello Ruby"' },
        { name: "Kotlin", id: "kotlin", version: "1.8.20", mode: "kotlin", snippet: 'fun main() {\n    println("Hello Kotlin")\n}' },
        { name: "Bash", id: "bash", version: "5.2.0", mode: "sh", snippet: 'echo "Hello Bash"' },
        { name: "Perl", id: "perl", version: "5.36.0", mode: "perl", snippet: 'print "Hello Perl\\n";' },
        { name: "R", id: "r", version: "4.2.3", mode: "r", snippet: 'print("Hello R")' },
        { name: "Lua", id: "lua", version: "5.4.4", mode: "lua", snippet: 'print("Hello Lua")' },
        { name: "Haskell", id: "haskell", version: "9.0.1", mode: "haskell", snippet: 'main = putStrLn "Hello Haskell"' },
        { name: "Scala", id: "scala", version: "3.2.2", mode: "scala", snippet: 'object Main extends App {\n  println("Hello Scala")\n}' },
        { name: "Dart", id: "dart", version: "2.19.6", mode: "dart", snippet: 'void main() {\n  print("Hello Dart");\n}' },
        { name: "Pascal", id: "pascal", version: "3.2.2", mode: "pascal", snippet: 'program Hello;\nbegin\n  writeln(\'Hello Pascal\');\nend.' },
        { name: "Elixir", id: "elixir", version: "1.11.3", mode: "elixir", snippet: 'IO.puts "Hello Elixir"' },
        { name: "Julia", id: "julia", version: "1.9.0", mode: "julia", snippet: 'println("Hello Julia")' },
        { name: "Nim", id: "nim", version: "1.6.12", mode: "text", snippet: 'echo "Hello Nim"' }
    ];

    let currentLang = languages[0]; // Default to Python

    // --- 2. EDITOR SETUP ---
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setFontSize(14);
    editor.setShowPrintMargin(false);
    editor.setValue(currentLang.snippet, -1);

    // --- 3. DROPDOWN LOGIC ---
    const langSearch = document.getElementById('langSearch');
    const langList = document.getElementById('langList');

    function renderLangList() {
        langList.innerHTML = '';
        languages.forEach(lang => {
            const div = document.createElement('div');
            div.className = 'lang-option';
            div.innerText = lang.name;
            div.onclick = () => selectLanguage(lang);
            if(lang.id === currentLang.id) div.classList.add('selected');
            langList.appendChild(div);
        });
    }

    function toggleLangList() { langList.classList.toggle('show'); }

    function filterLanguages() {
        const term = langSearch.value.toLowerCase();
        const options = langList.getElementsByClassName('lang-option');
        for (let opt of options) {
            opt.style.display = opt.innerText.toLowerCase().includes(term) ? "block" : "none";
        }
        langList.classList.add('show');
    }

    function selectLanguage(lang) {
        currentLang = lang;
        langSearch.value = lang.name;
        langList.classList.remove('show');
        editor.session.setMode("ace/mode/" + lang.mode);
        editor.setValue(lang.snippet, -1);
        
        // Reset Placeholder
        document.getElementById('stdin').placeholder = "Enter input here BEFORE running your code...\nExample:\nJohn\n25";
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.lang-selector-container')) langList.classList.remove('show');
    });
    renderLangList();
    langSearch.value = currentLang.name;

    // --- 4. SMART INPUT CHECK ---
    function codeNeedsInput(langId, code) {
        if (!code) return false;
        code = code.toLowerCase();
        
        // Check for common input patterns
        if (langId === 'python' && code.includes('input(')) return true;
        if (langId.includes('c++') && code.includes('cin')) return true;
        if (langId.includes('c') && code.includes('scanf')) return true;
        if (langId === 'java' && (code.includes('scanner') || code.includes('system.in'))) return true;
        if (langId === 'go' && code.includes('scan')) return true;
        if (langId === 'ruby' && code.includes('gets')) return true;
        if (langId === 'kotlin' && code.includes('readline')) return true;
        
        return false;
    }

    // --- 5. RUN CODE (PISTON API) ---
    async function runCode() {
        const runBtn = document.getElementById('runBtn');
        const outputDiv = document.getElementById('output');
        const code = editor.getValue();
        const stdin = document.getElementById('stdin').value;

        // Mobile Scroll Logic
        if (window.innerWidth <= 768) {
            document.getElementById('io-output-box').scrollIntoView({ behavior: 'smooth' });
        }

        // Smart Warning
        if (codeNeedsInput(currentLang.id, code) && !stdin.trim()) {
            const proceed = confirm("âš ï¸ WAITING FOR INPUT?\n\nThis compiler is non-interactive. You must enter your input in the 'Input (stdin)' box BEFORE clicking Run.\n\nYour code seems to ask for input, but the box is empty.\n\nClick OK to run anyway, or Cancel to enter input.");
            if (!proceed) {
                document.getElementById('stdin').focus();
                return; 
            }
        }

        // UI Updates
        runBtn.disabled = true;
        runBtn.innerHTML = 'â³ Running...';
        outputDiv.innerText = "Compiling & Executing...";
        outputDiv.style.color = "#a3a3a3";

        const payload = {
            "language": currentLang.id,
            "version": currentLang.version,
            "files": [ { "content": code } ],
            "stdin": stdin
        };

        try {
            const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.run) {
                if (data.run.stderr) {
                    outputDiv.innerText = data.run.stderr;
                    outputDiv.style.color = "#ef4444"; // Red for errors
                } else {
                    outputDiv.innerText = data.run.stdout;
                    outputDiv.style.color = "#86efac"; // Light Green for success
                }
            } else {
                outputDiv.innerText = "Error: " + (data.message || "Unknown error");
                outputDiv.style.color = "#ef4444";
            }

        } catch (error) {
            outputDiv.innerText = "Network Error: " + error.message;
            outputDiv.style.color = "#ef4444";
        } finally {
            runBtn.disabled = false;
            runBtn.innerHTML = 'â–¶ Run Code';
        }
    }
</script>
{% endblock %}