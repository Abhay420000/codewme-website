{% extends 'base.html' %}

{% block title %}Online Compiler - CodeWme{% endblock %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/online_compiler.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.min.js"></script>
{% endblock %}

{% block content %}
<div class="compiler-wrapper">
    
    <div class="compiler-header">
        <div class="header-left">
            <div class="compiler-icon">üíª</div>
            <div>
                <h1 class="compiler-title">Code Playground</h1>
                <p class="compiler-sub">Run code instantly. 30+ Languages Supported.</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="lang-selector-container">
                <input type="text" id="langSearch" class="lang-search-input" placeholder="Search Language..." onkeyup="filterLanguages()" onclick="toggleLangList()">
                <div id="langList" class="lang-list">
                    </div>
            </div>

            <button id="runBtn" class="btn-run" onclick="runCode()">
                ‚ñ∂ Run Code
            </button>
        </div>
    </div>

    <div class="compiler-grid">
        
        <div class="editor-container">
            <div class="panel-label">Source Code</div>
            <div id="editor"></div>
        </div>

        <div class="io-container">
            
            <div class="io-box" style="flex: 0 0 30%;">
                <div class="panel-label">Input (stdin)</div>
                <textarea id="stdin" class="io-textarea" placeholder="‚ö†Ô∏è For interactive programs:&#10;Enter all user inputs here on separate lines BEFORE clicking Run.&#10;&#10;Example:&#10;John&#10;25"></textarea>
            </div>

            <div class="io-box" style="flex: 1;">
                <div class="panel-label">Output (stdout)</div>
                <div id="output" class="io-output"></div>
            </div>

        </div>
    </div>

</div>

<script>
    // --- 1. LANGUAGE CONFIGURATION ---
    const languages = [
        { name: "Python", id: "python", version: "3.10.0", mode: "python", snippet: 'print("Hello from Python!")\nname = input("Enter name: ")\nprint(f"Nice to meet you, {name}")' },
        { name: "JavaScript", id: "javascript", version: "18.15.0", mode: "javascript", snippet: 'console.log("Hello from NodeJS!");' },
        { name: "Java", id: "java", version: "15.0.2", mode: "java", snippet: 'import java.util.Scanner;\npublic class Main {\n    public static void main(String[] args) {\n        Scanner scanner = new Scanner(System.in);\n        System.out.println("Enter name:");\n        if(scanner.hasNext()) {\n            String name = scanner.nextLine();\n            System.out.println("Hello " + name);\n        } else {\n            System.out.println("No input provided in STDIN box!");\n        }\n    }\n}' },
        { name: "C++ (GCC)", id: "c++", version: "10.2.0", mode: "c_cpp", snippet: '#include <iostream>\nusing namespace std;\nint main() {\n    string name;\n    cout << "Enter Name: ";\n    if (cin >> name) {\n        cout << "Hello " << name;\n    } else {\n        cout << "No input found.";\n    }\n    return 0;\n}' },
        { name: "C (GCC)", id: "c", version: "10.2.0", mode: "c_cpp", snippet: '#include <stdio.h>\nint main() {\n    printf("Hello C World");\n    return 0;\n}' },
        { name: "C#", id: "csharp", version: "6.12.0", mode: "csharp", snippet: 'using System;\nclass Program {\n    static void Main() {\n        Console.WriteLine("Hello C#");\n    }\n}' },
        { name: "Go", id: "go", version: "1.16.2", mode: "golang", snippet: 'package main\nimport "fmt"\nfunc main() {\n    fmt.Println("Hello Go")\n}' },
        { name: "Rust", id: "rust", version: "1.68.2", mode: "rust", snippet: 'fn main() {\n    println!("Hello Rust");\n}' },
        { name: "PHP", id: "php", version: "8.2.3", mode: "php", snippet: '<?php\n  echo "Hello PHP";\n?>' },
        { name: "Swift", id: "swift", version: "5.3.3", mode: "swift", snippet: 'print("Hello Swift")' },
        { name: "TypeScript", id: "typescript", version: "5.0.3", mode: "typescript", snippet: 'const msg: string = "Hello TS";\nconsole.log(msg);' },
        { name: "Ruby", id: "ruby", version: "3.0.1", mode: "ruby", snippet: 'puts "Hello Ruby"' }
    ];

    let currentLang = languages[0]; 

    // --- 2. EDITOR SETUP ---
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setFontSize(14);
    editor.setShowPrintMargin(false);
    editor.setValue(currentLang.snippet, -1);

    // --- 3. DROPDOWN LOGIC ---
    const langSearch = document.getElementById('langSearch');
    const langList = document.getElementById('langList');

    function renderLangList() {
        langList.innerHTML = '';
        languages.forEach(lang => {
            const div = document.createElement('div');
            div.className = 'lang-option';
            div.innerText = lang.name;
            div.onclick = () => selectLanguage(lang);
            if(lang.id === currentLang.id) div.classList.add('selected');
            langList.appendChild(div);
        });
    }

    function toggleLangList() {
        langList.classList.toggle('show');
    }

    function filterLanguages() {
        const term = langSearch.value.toLowerCase();
        const options = langList.getElementsByClassName('lang-option');
        for (let opt of options) {
            const txt = opt.innerText.toLowerCase();
            opt.style.display = txt.includes(term) ? "block" : "none";
        }
        langList.classList.add('show');
    }

    function selectLanguage(lang) {
        currentLang = lang;
        langSearch.value = lang.name;
        langList.classList.remove('show');
        editor.session.setMode("ace/mode/" + lang.mode);
        editor.setValue(lang.snippet, -1);
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.lang-selector-container')) {
            langList.classList.remove('show');
        }
    });

    renderLangList();
    langSearch.value = currentLang.name;

    // --- 4. SMART INPUT CHECK ---
    function codeNeedsInput(langId, code) {
        if (!code) return false;
        code = code.toLowerCase();
        
        // Keywords indicating input requirement
        if (langId === 'python' && code.includes('input(')) return true;
        if (langId.includes('c++') && code.includes('cin')) return true;
        if (langId.includes('c') && code.includes('scanf')) return true;
        if (langId === 'java' && (code.includes('scanner') || code.includes('system.in'))) return true;
        
        return false;
    }

    // --- 5. EXECUTION LOGIC ---
    async function runCode() {
        const runBtn = document.getElementById('runBtn');
        const outputDiv = document.getElementById('output');
        const code = editor.getValue();
        const stdin = document.getElementById('stdin').value;

        // SMART WARNING
        if (codeNeedsInput(currentLang.id, code) && !stdin.trim()) {
            const proceed = confirm("‚ö†Ô∏è WAITING FOR INPUT?\n\nThis compiler is non-interactive. You must enter your input in the 'Input (stdin)' box BEFORE running.\n\nYour code seems to ask for input, but the box is empty.\n\nClick OK to run anyway, or Cancel to enter input.");
            if (!proceed) {
                document.getElementById('stdin').focus();
                return; 
            }
        }

        // UI Updates
        runBtn.disabled = true;
        runBtn.innerHTML = '‚è≥ Running...';
        outputDiv.innerText = "Compiling & Executing...";
        outputDiv.style.color = "#a3a3a3";

        const payload = {
            "language": currentLang.id,
            "version": currentLang.version,
            "files": [ { "content": code } ],
            "stdin": stdin
        };

        try {
            const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.run) {
                if (data.run.stderr) {
                    outputDiv.innerText = data.run.stderr;
                    outputDiv.style.color = "#ef4444"; // Red
                } else {
                    outputDiv.innerText = data.run.stdout;
                    outputDiv.style.color = "#86efac"; // Light Green
                }
            } else {
                outputDiv.innerText = "Error: " + (data.message || "Unknown error");
                outputDiv.style.color = "#ef4444";
            }

        } catch (error) {
            outputDiv.innerText = "Network Error: " + error.message;
            outputDiv.style.color = "#ef4444";
        } finally {
            runBtn.disabled = false;
            runBtn.innerHTML = '‚ñ∂ Run Code';
        }
    }
</script>
{% endblock %}