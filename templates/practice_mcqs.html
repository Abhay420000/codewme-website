{% extends 'base.html' %}

{% block title %}Practice MCQs - CodeWme{% endblock %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/practice_mcqs.css') }}">
<style>
    /* Simple animation for new items loaded via JS */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Hide button if needed */
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="practice-header">
    <div class="practice-icon">üìù</div>
    <h1 class="practice-title">Practice Questions</h1>
    <p class="practice-sub">Prepare for your certification exams with our curated sets.</p>
</div>

<div class="section-heading-wrapper">
    <h2 class="section-heading">Available Sets</h2>
    <div class="section-underline"></div>
</div>

<div class="practice-grid" id="setsGrid">
    
    {% if initial_sets %}
        {% for s in initial_sets %}
        <a href="/mcqs/{{ s.url_slug }}/set-{{ s.set_num }}" class="card set-card-item">
            <div class="set-card-icon">
                <span>‚òÅÔ∏è</span>
            </div>
            <div class="card-body" style="text-align: left;">
                <div class="card-meta">
                    <span class="card-tag">{{ s.tag | upper }}</span>
                    <span>Set {{ s.set_num }}</span>
                </div>
                <h3 class="card-title">{{ s.category }}</h3>
                
                <p class="card-desc">{{ s.description }}</p>
            </div>
        </a>
        {% endfor %}
    {% else %}
        <div class="card" style="padding: 2rem; opacity: 0.6; grid-column: 1 / -1; text-align: center;">
            <h3 class="card-title">No Questions Found</h3>
            <p class="card-desc">The database is empty. Please use the Builder to add questions.</p>
        </div>
    {% endif %}

</div>

<div class="load-more-container" style="text-align: center; padding: 2rem 0 4rem 0;">
    <button id="loadMoreBtn" 
            class="btn-load-more" 
            style="background-color: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); padding: 0.8rem 2.5rem; border-radius: 2rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; {% if initial_sets|length < 6 %}display:none;{% endif %}">
        Load More Sets
    </button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let currentPage = 1;
        const loadBtn = document.getElementById('loadMoreBtn');
        const grid = document.getElementById('setsGrid');

        if(loadBtn) {
            loadBtn.addEventListener('click', function() {
                // 1. Prepare UI
                const nextPage = currentPage + 1;
                const originalText = loadBtn.innerText;
                loadBtn.innerText = "Loading...";
                loadBtn.disabled = true;

                // 2. Call the API
                fetch(`/api/load-sets?page=${nextPage}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.sets.length > 0) {
                            
                            // 3. Render New Cards
                            data.sets.forEach(s => {
                                // Create HTML String for Card
                                const cardHtml = `
                                    <a href="/mcqs/${s.url_slug}/set-${s.set_num}" class="card set-card-item fade-in" style="text-decoration: none; display: flex;">
                                        <div class="set-card-icon">
                                            <span>‚òÅÔ∏è</span>
                                        </div>
                                        <div class="card-body" style="text-align: left;">
                                            <div class="card-meta">
                                                <span class="card-tag">${s.tag.toUpperCase()}</span>
                                                <span>Set ${s.set_num}</span>
                                            </div>
                                            <h3 class="card-title">${s.category}</h3>
                                            <p class="card-desc">${s.description}</p>
                                        </div>
                                    </a>
                                `;
                                grid.insertAdjacentHTML('beforeend', cardHtml);
                            });

                            // 4. Update State
                            currentPage = nextPage;
                            
                            // 5. Hide button if no more data (API tells us 'has_more')
                            if (!data.has_more) {
                                loadBtn.style.display = 'none';
                            }

                        } else {
                            // No data returned
                            loadBtn.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sets:', error);
                        alert('Error loading more sets. Please try again.');
                    })
                    .finally(() => {
                        // 6. Reset Button
                        loadBtn.innerText = originalText;
                        loadBtn.disabled = false;
                    });
            });
        }
    });
</script>
{% endblock %}