{% extends 'base.html' %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/article.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/mcq.css') }}">
<style>
    .q-type-badge {
        font-size: 0.75rem;
        background-color: var(--bg-read-only, #e2e8f0);
        color: var(--text-muted);
        padding: 2px 8px;
        border-radius: 12px;
        vertical-align: middle;
        margin-left: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .mcq-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        display: block;
    }
</style>
{% endblock %}

{% block title %}{{ title }} - CodeWme{% endblock %}
{% block meta_description %}Practice {{ title }}. Free mock exam questions with detailed explanations and answers.{% endblock %}

{% block content %}
<div class="layout-split">
    
    <div class="content-col mcq-container">
        
        <div class="article-header">
            <span class="card-tag" style="font-size: 0.9rem;">{{ category | upper }}</span>
            <h1 class="article-h1" style="margin-top:10px;">{{ title }}</h1>
        </div>

        <div class="rec-box">
            üìù <strong>Instructions:</strong> Read the hint to know if you need to select one or multiple options.
        </div>

        {% for q in questions %}
        <div class="card mcq-card" id="q{{ loop.index }}">
            
            {% if q.correct is string %}
                {% set correct_list = [q.correct] %}
            {% elif q.correct is iterable and q.correct is not string %}
                {% set correct_list = q.correct %}
            {% else %}
                {% set correct_list = [] %}
            {% endif %}

            {% set is_multi = correct_list | length > 1 %}

            <h3 class="article-h3" style="margin-top: 0; font-size: 1.2rem; color: var(--text-header);">
                <a href="#q{{ loop.index }}" class="question-anchor" title="Link to this question">#{{ loop.index }}</a>
                {{ q.question }}
                
                <span class="q-type-badge">
                    {{ 'Select all that apply' if is_multi else 'Select 1' }}
                </span>
            </h3>

            {% if q.image_url %}
            <div style="margin: 1rem 0;">
                <img src="{{ q.image_url }}" alt="Question Image" class="mcq-image">
            </div>
            {% endif %}

            <div class="mcq-options-list" id="opts-{{ q.id }}" data-mode="{{ 'multi' if is_multi else 'single' }}">
                {% for opt in q.options %}
                
                {% set is_correct = opt.strip() in correct_list %}

                <div class="mcq-option" 
                     data-correct="{{ 'true' if is_correct else 'false' }}"
                     onclick="toggleSelection(this)">
                    
                    <span class="option-label">
                        {{ ["A","B","C","D","E"][loop.index0] }}.
                    </span>
                    {{ opt }}
                </div>
                {% endfor %}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <span class="result-status" id="status-{{ q.id }}" style="font-weight:bold; opacity:0; transition: opacity 0.3s;"></span>
                
                <button onclick="checkAnswer(this, 'ans-{{ q.id }}', 'opts-{{ q.id }}', 'status-{{ q.id }}')" class="answer-reveal-btn">
                    Check Answer
                </button>
            </div>

            <div id="ans-{{ q.id }}" class="answer-box">
                <p class="correct-text">
                    ‚úÖ Answer: {{ correct_list | join(', ') }}
                </p>
                <hr style="border:0; border-top:1px solid var(--border-color); margin: 15px 0;">
                <div class="explanation-text">
                    <strong>Explanation:</strong><br>
                    {{ q.explanation }}
                </div>
            </div>

        </div>
        {% endfor %}

        <div class="quiz-nav">
            {% if has_next %}
            <a href="/mcqs/{{ category | replace(' ', '-') | lower }}/set-{{ set_num + 1 }}" class="btn-next-set">
                Next Set (Set {{ set_num + 1 }}) &rarr;
            </a>
            {% else %}
            <div style="padding: 20px; background: var(--ad-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                <p style="margin:0; color:var(--text-muted);">üéâ You have reached the end of this series!</p>
                <a href="/practice-mcqs" style="color:var(--primary); font-weight:bold; margin-top:10px; display:inline-block;">Back to Practice Dashboard</a>
            </div>
            {% endif %}
        </div>

    </div>

    <aside class="sidebar-col">
        <div class="sidebar-box">
            <h3 class="sidebar-title">Browse Sets</h3>
            <ul class="sidebar-list">
                <li><a href="/practice-mcqs">‚Üê Back to All Sets</a></li>
                {% for s in sidebar_sets %}
                <li><a href="/mcqs/{{ s.url_slug }}/set-{{ s.set_num }}">Set {{ s.set_num }}</a></li>
                {% endfor %}
            </ul>
        </div>
        
        </aside>

</div>

<script>
    // 1. Toggle Selection State
    function toggleSelection(el) {
        const parent = el.closest('.mcq-options-list'); 
        if (!parent) return;

        // If locked (already checked), do nothing
        if (parent.classList.contains('checked-mode')) return;

        const mode = parent.getAttribute('data-mode'); // 'single' or 'multi'
        
        if (mode === 'single') {
            // Radio Button Behavior: Deselect all others
            const siblings = parent.querySelectorAll('.mcq-option');
            siblings.forEach(sib => {
                if (sib !== el) {
                    sib.classList.remove('selected');
                }
            });
            // Always select the clicked one
            el.classList.add('selected');
        } else {
            // Checkbox Behavior: Toggle self
            el.classList.toggle('selected');
        }
    }

    // 2. Validate Answers
    function checkAnswer(btn, ansId, optsId, statusId) {
        const ansBox = document.getElementById(ansId);
        const optionsList = document.getElementById(optsId);
        const statusLbl = document.getElementById(statusId);
        
        // Select all option divs securely
        const allOptions = optionsList.querySelectorAll('.mcq-option');

        // --- MODE: HIDE / RESET ---
        if (ansBox.style.display === 'block') {
            ansBox.style.display = 'none';
            btn.innerText = "Check Answer";
            
            // Unlock options
            optionsList.classList.remove('checked-mode');
            statusLbl.style.opacity = '0';
            
            // Remove validation classes (keep 'selected' so user doesn't lose work)
            allOptions.forEach(opt => {
                opt.classList.remove('correct', 'incorrect', 'missed');
            });
            return;
        }

        // --- MODE: CHECK ---
        ansBox.style.display = 'block';
        btn.innerText = "Hide Answer";
        optionsList.classList.add('checked-mode'); // Lock clicks

        let anyIncorrect = false;
        let missedCorrect = false;
        let userSelectedCount = 0;
        let totalCorrectCount = 0;

        allOptions.forEach(opt => {
            const isSelected = opt.classList.contains('selected');
            const isActuallyCorrect = opt.getAttribute('data-correct') === 'true';

            if (isActuallyCorrect) totalCorrectCount++;
            if (isSelected) userSelectedCount++;

            if (isSelected && isActuallyCorrect) {
                // Good job
                opt.classList.add('correct'); 
            } else if (isSelected && !isActuallyCorrect) {
                // Wrong choice
                opt.classList.add('incorrect');
                anyIncorrect = true;
            } else if (!isSelected && isActuallyCorrect) {
                // Missed it
                opt.classList.add('missed');
                missedCorrect = true;
            }
        });

        // Determine Status Message
        statusLbl.style.opacity = '1';
        if (userSelectedCount === 0) {
            statusLbl.innerText = "‚ö†Ô∏è No Option Selected";
            statusLbl.style.color = "#64748b";
        } else if (anyIncorrect || missedCorrect) {
            // STRICT MODE: Any wrong selection OR missing correct option = Incorrect
            statusLbl.innerText = "‚ùå Incorrect";
            statusLbl.style.color = "#ef4444";
        } else {
            statusLbl.innerText = "‚úÖ Correct!";
            statusLbl.style.color = "#22c55e";
        }
    }
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "{{ title }}",
  "hasPart": [
    {% for q in questions %}
    
    {# --- Safety Check for Answer Text --- #}
    {% set safe_correct = '' %}
    {% if q.correct %}
        {% if q.correct is string %}
            {% set safe_correct = q.correct %}
        {% elif q.correct is iterable %}
            {% set safe_correct = q.correct | join(', ') %}
        {% endif %}
    {% else %}
        {% set safe_correct = 'See Explanation' %}
    {% endif %}
    
    {
      "@type": "Question",
      "name": "{{ q.question | replace('"', '\\"') | replace('\n', ' ') }}",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ safe_correct | replace('"', '\\"') | replace('\n', ' ') }}"
      },
      "suggestedAnswer": [
        {% for opt in q.options %}
        {
          "@type": "Answer",
          "text": "{{ opt | replace('"', '\\"') | replace('\n', ' ') }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}