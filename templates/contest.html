{% extends 'base.html' %}

{% block title %}Coding Contests - CodeWme{% endblock %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/contest.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/home.css') }}">
{% endblock %}

{% block content %}
<div class="contest-container">
    
    <div class="contest-icon">üèÜ</div>
    
    <h1 class="contest-title">Coding Contests</h1>
    <p class="contest-sub">Compete with developers around the world, solve algorithmic challenges, and climb the leaderboard.</p>

    <div class="section-header">
        <h2 class="section-title">Live & Upcoming Contests</h2>
        <div class="section-underline"></div>
    </div>
    
    {% if live_contests %}
    <div class="grid-cards" id="liveContestsGrid">
        {% for contest in live_contests %}
        <a href="#register-{{ contest.id }}" 
           class="card contest-item live-item" 
           data-start-date="{{ contest.start_date }}"
           data-price="{{ contest.price }}">
        
            <div class="card-img-wrapper">
                {% if contest.image_url %}
                    <img src="{{ contest.image_url }}" class="card-img" alt="{{ contest.title }}">
                {% else %}
                    <div class="card-placeholder">
                        <div class="placeholder-icon">üíª</div>
                        <div class="placeholder-text">{{ contest.tag | upper }}</div>
                    </div>
                {% endif %}
            </div>

            <div class="card-body">
                <div class="card-meta">
                    <span class="card-tag">{{ contest.tag | upper }}</span>
                    <span class="contest-status" id="status-{{ contest.id }}">Upcoming</span>
                </div>
                <h3 class="card-title">{{ contest.title }}</h3>
                <p class="card-desc">{{ contest.description }}</p>
            </div>
            <div class="contest-footer">
                <span class="contest-price">{{ "$%.2f"|format(contest.price) if contest.price > 0 else "FREE" }}</span>
                <span class="contest-time-left" id="countdown-{{ contest.id }}"></span>
            </div>
        </a>
        {% endfor %}
    </div>
    <div class="load-more-container">
        <button id="loadMoreLiveBtn" class="btn-load-more" style="display: none;">Load More Live Contests</button>
    </div>
    {% else %}
    <p class="empty-state">No live or upcoming contests currently scheduled. Check back soon!</p>
    {% endif %}


    <div class="section-header" style="margin-top: 4rem;">
        <h2 class="section-title">Past Contests</h2>
        <div class="section-underline"></div>
    </div>
    
    {% if expired_contests %}
    <div class="grid-cards" id="expiredContestsGrid">
        {% for contest in expired_contests %}
        <div class="card contest-item expired-item" style="opacity: 0.6; pointer-events: none;">
            <div class="card-img-wrapper">
                {% if contest.image_url %}
                    <img src="{{ contest.image_url }}" class="card-img" alt="{{ contest.title }}">
                {% else %}
                    <div class="card-placeholder">
                        <div class="placeholder-icon">‚ùå</div>
                        <div class="placeholder-text">{{ contest.tag | upper }}</div>
                    </div>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="card-meta">
                    <span class="card-tag">{{ contest.tag | upper }}</span>
                    <span class="contest-status expired">EXPIRED</span>
                </div>
                <h3 class="card-title">{{ contest.title }}</h3>
                <p class="card-desc">{{ contest.description }}</p>
            </div>
            <div class="contest-footer">
                <span class="contest-price">Ended {{ contest.end_date.split(' ')[0] }}</span>
                <a href="#leaderboard" class="btn-leaderboard">View Leaderboard</a>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="load-more-container">
        <button id="loadMoreExpiredBtn" class="btn-load-more" style="display: none;">Load More Expired Contests</button>
    </div>
    {% else %}
    <p class="empty-state">No past contests found.</p>
    {% endif %}

</div>

<div id="registrationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('registrationModal')">&times;</span>
        <h3 class="modal-title">Register for <span id="modal-contest-title"></span></h3>
        <p class="modal-sub">Step 1: Verify your email to continue.</p>
        
        <div id="emailStep">
            <label for="regEmail">Email Address:</label>
            <input type="email" id="regEmail" placeholder="Enter your email" required>
            <label for="regPassword">Password (Simulation):</label>
            <input type="password" id="regPassword" placeholder="Enter your password" required>
            <button class="btn-modal-primary" onclick="simulateOtpSend()">Send Verification Code</button>
        </div>
        
        <div id="otpStep" style="display: none;">
            <p id="otp-status-message" class="info-message">A 6-digit code has been sent to your email.</p>
            <label for="regOtp">Verification Code (6 digits):</label>
            <input type="text" id="regOtp" placeholder="Enter OTP" required>
            <button class="btn-modal-primary" onclick="simulateOtpVerification()">Verify and Proceed to Payment</button>
            <p class="otp-hint">Note: If you don't receive the email, check the Python console for the OTP.</p>
        </div>
        
    </div>
</div>

<div id="paymentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('paymentModal')">&times;</span>
        <h3 class="modal-title">Step 2: Complete Registration</h3>
        <p class="modal-sub">Total Payable: <span id="payment-amount" class="contest-price"></span></p>
        
        <div id="payment-form">
            <label for="cardDetails">Card Details (Simulation):</label>
            <input type="text" id="cardDetails" placeholder="1234 5678 9012 3456" required>
            <button class="btn-modal-success" onclick="simulatePaymentCompletion()">Confirm Payment (Simulated)</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- CONFIGURATION ---
        const LIVE_LIMIT = 4;
        const EXPIRED_LIMIT = 2;
        const LOAD_STEP = 6;
        
        const liveCards = document.querySelectorAll('.live-item');
        const expiredCards = document.querySelectorAll('.expired-item');
        const liveLoadBtn = document.getElementById('loadMoreLiveBtn');
        const expiredLoadBtn = document.getElementById('loadMoreExpiredBtn');

        let visibleLiveCount = 0;
        let visibleExpiredCount = 0;

        // --- GLOBAL MODAL FUNCTIONS ---
        let currentContestId = null;

        function openModal(modalId, contestId) {
            currentContestId = contestId;
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }


        // --- 1. INITIAL DISPLAY LOGIC ---
        function initializeContests(cards, limit, loadBtn, visibleCountRef, loadStep, isLive) {
            cards.forEach(card => card.style.display = 'none');
            
            let currentVisible = 0;
            for(let i = 0; i < cards.length && currentVisible < limit; i++) {
                cards[i].style.display = 'flex';
                currentVisible++;
            }

            if (isLive) {
                visibleLiveCount = currentVisible;
            } else {
                visibleExpiredCount = currentVisible;
            }

            if (cards.length > limit) {
                loadBtn.style.display = 'block';
            }
        }
        
        // --- 2. LOAD MORE HANDLERS ---
        function createLoadMoreHandler(cards, limit, loadBtn, getVisibleCount, setVisibleCount) {
            return function() {
                let currentVisible = getVisibleCount();
                const nextCount = currentVisible + LOAD_STEP;
                
                for(let i = currentVisible; i < nextCount && i < cards.length; i++) {
                    cards[i].style.display = 'flex';
                    cards[i].style.animation = "fadeIn 0.5s ease";
                }
                
                setVisibleCount(Math.min(nextCount, cards.length));

                if(getVisibleCount() >= cards.length) {
                    loadBtn.style.display = 'none';
                }
            };
        }

        liveLoadBtn.addEventListener('click', createLoadMoreHandler(
            liveCards, LIVE_LIMIT, liveLoadBtn, 
            () => visibleLiveCount, (count) => visibleLiveCount = count
        ));

        expiredLoadBtn.addEventListener('click', createLoadMoreHandler(
            expiredCards, EXPIRED_LIMIT, expiredLoadBtn, 
            () => visibleExpiredCount, (count) => visibleExpiredCount = count
        ));

        // Initialize display
        initializeContests(liveCards, LIVE_LIMIT, liveLoadBtn, visibleLiveCount, LOAD_STEP, true);
        initializeContests(expiredCards, EXPIRED_LIMIT, expiredLoadBtn, visibleExpiredCount, LOAD_STEP, false);
        
        // --- 3. COUNTDOWN AND STATUS LOGIC ---
        function updateContestTimers() {
            const now = new Date().getTime();
            
            liveCards.forEach(card => {
                const startDateString = card.dataset.startDate;
                const startDate = new Date(startDateString.replace(' ', 'T')).getTime(); // ISO format conversion
                const countdownEl = document.getElementById('countdown-' + card.href.split('-').pop());
                const statusEl = document.getElementById('status-' + card.href.split('-').pop());
                
                if (!statusEl || !countdownEl) return;

                const diff = startDate - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                
                if (diff < 0) {
                    // Contest is Ongoing/Live (for simplicity, we assume live when start date passes)
                    const end = new Date(card.dataset.endDate.replace(' ', 'T')).getTime();
                    const liveHours = Math.floor((end - now) / (1000 * 60 * 60));
                    
                    if (liveHours > 0) {
                        statusEl.innerText = "LIVE NOW";
                        statusEl.style.backgroundColor = "#22c55e"; // Success green
                        countdownEl.innerText = `${liveHours} hrs left`;
                        card.href = "#join-contest"; // Simulated join link
                    } else {
                        // The get_contests helper should have moved this to expired, but for safety:
                        statusEl.innerText = "ENDED";
                        statusEl.style.backgroundColor = "#ef4444"; // Danger red
                        countdownEl.innerText = "Check Results";
                        card.href = "#results";
                    }

                } else {
                    // Contest is Upcoming
                    statusEl.innerText = "UPCOMING";
                    statusEl.style.backgroundColor = "rgba(59, 130, 246, 0.1)"; // Primary blue background
                    countdownEl.innerText = `Starts in ${hours + 1} hrs`;
                }
            });
        }
        
        // Update timers immediately and every hour (or more frequently for testing)
        updateContestTimers();
        setInterval(updateContestTimers, 600000); // Update every 10 minutes (600000ms) for production, or 1000ms for testing

        // --- 4. SIMULATED ANTI-CHEATING LOGIC (Frontend Only) ---
        let tabShiftCount = 0;
        let lastShiftTime = 0;
        const MAX_SHIFTS = 3;
        const TIME_WINDOW = 10000; // 10 seconds

        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                const now = new Date().getTime();
                if (now - lastShiftTime < TIME_WINDOW) {
                    tabShiftCount++;
                } else {
                    tabShiftCount = 1; // Reset count if time window passed
                }
                lastShiftTime = now;
                
                if (tabShiftCount > MAX_SHIFTS) {
                    if (window.location.href.includes('#join-contest')) {
                        alert(`üõë ANTI-CHEATING ALERT: Tab shift limit exceeded (${MAX_SHIFTS} times in 10s). Your exam has been automatically submitted.`);
                        // Here you would send an AJAX request to the server to submit the contest
                        window.location.href = "/contest"; // Redirect away from simulated exam
                    }
                }
            }
        });
        
        // --- REAL-TIME STEP 1: OTP SEND ---
        async function simulateOtpSend() {
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (!email || !password) {
                alert("Please enter both email and a password.");
                return;
            }
            
            // Disable button during request
            const button = document.querySelector('#emailStep button');
            button.disabled = true;
            button.innerText = 'Sending...';

            try {
                const response = await fetch('/api/contest/send_otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, contest_id: currentContestId })
                });

                const data = await response.json();

                if (data.success) {
                    alert("Verification code sent! Check your inbox.");
                    
                    // Switch to OTP step
                    document.getElementById('emailStep').style.display = 'none';
                    document.getElementById('otpStep').style.display = 'block';
                    
                    // Update status message
                    document.getElementById('otp-status-message').innerHTML = '‚úÖ Code sent to <strong style="color:var(--primary);">' + email + '</strong>.';

                } else {
                    alert("Error: " + data.message);
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                alert("Network error. Could not connect to server or SMTP configuration failed.");
            } finally {
                button.disabled = false;
                button.innerText = 'Send Verification Code';
            }
        }

        // --- REAL-TIME STEP 2: OTP VERIFICATION ---
        async function simulateOtpVerification() {
            const enteredOtp = document.getElementById('regOtp').value.trim();
            
            if (!enteredOtp) {
                alert("Please enter the OTP.");
                return;
            }
            
            const button = document.querySelector('#otpStep button');
            button.disabled = true;
            button.innerText = 'Verifying...';

            try {
                const response = await fetch('/api/contest/verify_otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ otp: enteredOtp })
                });

                const data = await response.json();

                if (data.success) {
                    alert("Verification successful! Proceeding to payment.");
                    
                    // Close registration modal
                    closeModal('registrationModal');
                    
                    // Open payment modal
                    openModal('paymentModal', currentContestId);
                    
                    // Set payment price (get from card metadata)
                    const priceEl = document.querySelector(`a[href="#register-${currentContestId}"]`);
                    const price = priceEl ? priceEl.dataset.price : 0;
                    document.getElementById('payment-amount').innerText = price > 0 ? `$${parseFloat(price).toFixed(2)}` : 'FREE (Registration Fee)';
                    
                } else {
                    alert("‚ùå " + data.message);
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                alert("Network error during verification.");
            } finally {
                button.disabled = false;
                button.innerText = 'Verify and Proceed to Payment';
            }
        }
        
        // --- REAL-TIME STEP 3: PAYMENT COMPLETION ---
        async function simulatePaymentCompletion() {
             const cardDetails = document.getElementById('cardDetails').value.trim();
             if (!cardDetails) {
                 alert("Please enter simulated card details.");
                 return;
             }
            
             const button = document.querySelector('#paymentModal button');
             button.disabled = true;
             button.innerText = 'Processing...';

             try {
                const response = await fetch('/api/contest/confirm_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) 
                });

                const data = await response.json();

                if (data.success) {
                    alert("‚úÖ Payment Confirmed! You are registered for the contest!");
                    closeModal('paymentModal');
                    
                    // Update the card visually and set it to the 'join-contest' state
                    const registeredCard = document.querySelector(`a[href="#register-${currentContestId}"]`);
                    if (registeredCard) {
                        registeredCard.href = "#join-contest";
                        registeredCard.querySelector('.contest-status').innerText = 'REGISTERED';
                        registeredCard.querySelector('.contest-status').style.backgroundColor = '#8b5cf6';
                        registeredCard.querySelector('.contest-time-left').innerText = 'Ready to Join!';
                    }
                } else {
                    alert("Payment failed: " + data.message);
                }
             } catch (error) {
                console.error("Fetch Error:", error);
                alert("Network error during payment confirmation.");
             } finally {
                button.disabled = false;
                button.innerText = 'Confirm Payment (Simulated)';
             }
        }

        // --- 5. INITIAL CARD CLICK HANDLER ---
        document.getElementById('liveContestsGrid').addEventListener('click', function(e) {
            let target = e.target.closest('.live-item');
            if (!target) return;
            
            e.preventDefault();
            const contestId = target.href.split('-').pop();
            const contestTitle = target.querySelector('.card-title').innerText;
            
            if (target.href.includes('#join-contest')) {
                // Already Registered / Live
                alert("‚úÖ You are registered! Starting the online compiler contest now (Simulated environment). The anti-cheating tab-shift monitor is active!");
                console.log("Simulated contest started. Anti-cheating monitoring is active.");
                return;
            }
            
            if (target.href.includes('#register-')) {
                // Upcoming - Start the registration flow
                document.getElementById('modal-contest-title').innerText = contestTitle;
                
                // Reset to email step for new flow
                document.getElementById('emailStep').style.display = 'block';
                document.getElementById('otpStep').style.display = 'none';
                document.getElementById('regEmail').value = '';
                document.getElementById('regOtp').value = '';
                document.getElementById('regPassword').value = '';
                
                openModal('registrationModal', contestId);
            }
        });
    });
</script>
